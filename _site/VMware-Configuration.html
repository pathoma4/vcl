<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>VMware Configuration | vcl</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="VMware Configuration" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Documentation for the Apache VCL (Virtual Computing Lab) project" />
<meta property="og:description" content="Documentation for the Apache VCL (Virtual Computing Lab) project" />
<link rel="canonical" href="http://localhost:4000/VMware-Configuration.html" />
<meta property="og:url" content="http://localhost:4000/VMware-Configuration.html" />
<meta property="og:site_name" content="vcl" />
<script type="application/ld+json">
{"url":"http://localhost:4000/VMware-Configuration.html","headline":"VMware Configuration","description":"Documentation for the Apache VCL (Virtual Computing Lab) project","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=f0d4f89b3f1fcc5f8004dc0148af29131ffeaf66">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">

      <h1><a href="http://localhost:4000/">VMware Configuration</a></h1> 


      <h2 id="terminology">Terminology</h2>

<p><strong>VM Host</strong></p>

<ul>
  <li>A VM host is a physical computer running a VMware hypervisor</li>
  <li>A VCL computer entry must be added for each VM host (Manage Computers &gt; Edit Computer Information)</li>
  <li>After the computer has been added to VCL, it is designated as a VM host by changing the computer state to vmhostinuse (Manage Computers &gt; Computer Utilities)</li>
</ul>

<p><strong>VM</strong></p>
<ul>
  <li>A VM is a virtual machine managed by VCL</li>
  <li>A computer entry must be added to VCL for each VM (Manage Computers &gt; Edit Computer Information)</li>
  <li>Each VM must be assigned to a VM host (Virtual Hosts &gt; VM Hosts tab &gt; Configure Host)</li>
  <li>VMs do not need to be created manually in VMware, VCL automatically creates and deletes VMs</li>
</ul>

<p><strong>VM Host Profile</strong></p>
<ul>
  <li>A VM host profile contains several parameters which describe how a VM host is configured so that VCL knows how to manage it</li>
  <li>Each VM host is assigned a VM host profile</li>
  <li>A VM host profile may be assigned to multiple VM hosts if they are configured identically</li>
  <li>VM host profiles may be added or modified via Virtual Hosts &gt; VM Host Profiles tab</li>
</ul>

<p><strong>VMware Products Supported</strong></p>
<ul>
  <li>VMware Server 2.x</li>
  <li>VMware ESX 3.5 - 4.x</li>
  <li>VMware ESXi 4.x</li>
  <li>VMware ESXi 5.x</li>
</ul>

<h2 id="vm-host-management-options">VM Host Management Options</h2>

<p>The VCL management node must be able to control the VM host and the VMs running on it.  VMware provides several different ways of doing this.  VCL currently supports the following methods for remote VM host management:</p>

<ul>
  <li>VMware vSphere SDK</li>
  <li>Use SSH to execute commands directly on the VM (not officially supported by VMware)</li>
</ul>

<p>The vSphere SDK can only be used if management is not restricted due to the VMware license key installed on the host.  This mainly affects hosts running the free version of ESXi.  Remote management using any of the methods supported by VMware is restricted once a free license key is entered.</p>

<p>If remote management is restricted, the VM host can be managed if SSH is enabled on it.  VCL will execute vim-cmd and other commands on the VM host via SSH.</p>

<h3 id="how-to-enable-ssh-on-the-vm-host">How to enable SSH on the VM host:</h3>

<p>VMware Server 2.x</p>
<ul>
  <li>Enable the SSH daemon and configure identity key authentication according to the underlying VM host OS</li>
</ul>

<p>ESX/ESXi 3.5 &amp; 4.0</p>
<ul>
  <li>Connect to the console of the ESX/ESXi host</li>
  <li>Press ALT-F1 - you should see a black screen with the VMware product name at the top</li>
  <li>Type the word unsupported and press Enter (you won’t see the letters appear as you type them)</li>
  <li>You should see a password prompt, type in the root password and press Enter</li>
  <li>Edit the file: vi /etc/inetd.conf</li>
  <li>Uncomment the first line beginning with #ssh by deleting the # character</li>
  <li>Save the file - press Esc and then :wq</li>
  <li>Kill the inetd process
    <ul>
      <li>Determine the PID of the inetd process: <em>ps grep inetd.</em> You should see a line that looks like: 5065 5065 busybox inetd</li>
      <li>Kill the process (enter the PID from the output of the previous command): kill -HUP 5065</li>
    </ul>
  </li>
</ul>

<p>ESXi 4.1</p>

<p>Beginning with ESXi 4.1, SSH can be enabled using the vSphere Client:</p>
<ul>
  <li>Select the ESXi host</li>
  <li>Select the Configuration tab</li>
  <li>Select Security Profile under Software</li>
  <li>Click Properties</li>
  <li>Select Remote Tech Support (SSH)</li>
  <li>Click Options</li>
  <li>Select Start automatically</li>
  <li>Click Start</li>
  <li>Click OK</li>
</ul>

<p>ESX 5.0</p>

<p>In the case of ESX 5.0:</p>
<ul>
  <li>Select the ESXi host</li>
  <li>Select the Configuration tab</li>
  <li>Select Security Profile under Software</li>
  <li>Click Properties</li>
  <li>Select SSH Server</li>
  <li>Click Options</li>
  <li>Confirm that Start automatically is selected</li>
  <li>Click OK</li>
</ul>

<p>How to configure ESX/ESXi to use SSH identity key authentication:</p>

<p>SSH identity key authentication must be configured if SSH is used to manage the VM host.</p>

<ul>
  <li>
    <p>Create an SSH key pair on the management node (or use a key you previously created):</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ssh-keygen -t rsa -f /etc/vcl/vcl.key -N '' -b 1024 -C 'VCL root account'
</code></pre></div>    </div>
  </li>
  <li>
    <p>Log into the ESX host via SSH (password authentication should work) and create the directory:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ssh &lt;ESXi host&gt; 'mkdir /.ssh'
</code></pre></div>    </div>
  </li>
  <li>
    <p>Copy the public key to the ESXi host:
ESXi 4.x:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  scp /etc/vcl/vcl.key.pub &lt;ESXi host&gt;:/.ssh/authorized_keys
</code></pre></div>    </div>
  </li>
  <li>
    <p>ESXi 5.x:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  scp /etc/vcl/vcl.key.pub &lt;ESXi host&gt;:/etc/ssh/keys-root/authorized_keys
</code></pre></div>    </div>
  </li>
  <li>
    <p>Test making an SSH connection using the key:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ssh -i /etc/vcl/vcl.key &lt;ESXi host&gt;
</code></pre></div>    </div>
  </li>
</ul>

<p><strong><em>IMPORTANT:</em></strong> Under ESXi 4.x, the authorized_keys file is erased when the ESXi VM host is rebooted. Complete the following steps to make the authorized_keys file persistent:</p>

<p><em>Note: VCL will perform these steps automatically when the 1st reservation assigned to the host is processed.</em></p>

<ul>
  <li>
    <p>Create a compressed tarball file containing the /.ssh directory:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  tar -C / -czf bootbank/vcl.tgz .ssh
</code></pre></div>    </div>
  </li>
  <li>
    <p>Edit the /bootbank/boot.cfg file and append ‘ — vcl.tgz’ to modules line as shown in the following example:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  kernel=b.z
  kernelopt=
  modules=k.z — s.z — c.z — oem.tgz — license.tgz — m.z — state.tgz — vcl.tgz
  build=4.1.0-260247
  updated=2
  bootstate=0
</code></pre></div>    </div>
  </li>
</ul>

<p>Optionally you can run the following two commands:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    tar -C / -czf vcl.tgz .ssh
    BootModuleConfig.sh --add=vcl.tgz --verbose
</code></pre></div></div>

<h2 id="vm-host-profile-parameters">VM Host Profile Parameters</h2>

<p><a href="VM-Host-Profiles.html">Here</a> is a page on the VM Host Profile Parameters so VCL know hows to manage the host profile.</p>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="http://github.com/pathoma4/vcl/edit/gh-pages/VMwareConfiguration.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
