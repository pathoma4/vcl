<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Configuring LDAP Authentication | vcl</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Configuring LDAP Authentication" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Documentation for the Apache VCL (Virtual Computing Lab) project" />
<meta property="og:description" content="Documentation for the Apache VCL (Virtual Computing Lab) project" />
<link rel="canonical" href="http://localhost:4000/Configuring-LDAP-Authentication.html" />
<meta property="og:url" content="http://localhost:4000/Configuring-LDAP-Authentication.html" />
<meta property="og:site_name" content="vcl" />
<script type="application/ld+json">
{"url":"http://localhost:4000/Configuring-LDAP-Authentication.html","headline":"Configuring LDAP Authentication","description":"Documentation for the Apache VCL (Virtual Computing Lab) project","@type":"WebPage","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=c4acafeb8164e1bbb60bac1d516570dc35afbc91">
  </head>
  <body>
    <div class="container-lg px-3 my-5 markdown-body">

      <h1><a href="http://localhost:4000/">Configuring LDAP Authentication</a></h1> 


      <h2 id="benefits-of-ldap-authentication">Benefits of LDAP Authentication</h2>

<p>Configuring the VCL website to authenticate users via LDAP is highly recommended if your organization has an existing LDAP directory infrastructure.</p>

<h3 id="account-synchronization-and-security">Account Synchronization and Security</h3>
<p>Using LDAP for VCL website user authentications relieves the VCL system administrators from having to create and manage user accounts, as well as synchronize user passwords.  The passwords of the users who authenticate via LDAP are never stored within any part of VCL.</p>

<h3 id="group-synchronization">Group Synchronization</h3>
<p>VCL allows user groups and user group membership from the LDAP directory to be synchronized to the VCL system.</p>

<h2 id="ldap-requirements">LDAP Requirements</h2>

<h3 id="server-requirements">Server Requirements</h3>
<p>Any variety of LDAP server can be used.  LDAP is one of the core technologies used by Microsoft Active Directory (AD) so a very common configuration is to use an AD domain controller to authenticate users to the VCL website.  You could also use OpenLDAP or some other LDAP provider.</p>

<p>VCL does not require any particular LDAP schema, directory structure, or directory organization.  The VCL website LDAP configuration can be configured to handle any structure or custom user object attributes.</p>

<h3 id="sslldaps">SSL/LDAPS</h3>

<p>Secure LDAP (ldaps://) and the corresponding SSL certificate must be properly configured and working on the LDAP server.</p>

<h3 id="firewall">Firewall</h3>

<p>The VCL web server must be able to connect to the LDAP server via the secure LDAP port, usually TCP 636.</p>

<h3 id="privileged-ldap-account">Privileged LDAP Account</h3>

<p><em>The privileged LDAP account requirement is not necessary if your LDAP directory server permits anonymous binds.</em></p>

<p>In order to utilize VCL LDAP group synchronization feature, a privileged user account must be configured in the LDAP directory.  The user account must have permissions to read the following attributes of all users who will log in to the VCL website:</p>

<ul>
  <li>First name</li>
  <li>Last name</li>
  <li>User login</li>
  <li>Email address (optional)</li>
</ul>

<h3 id="vcl-web-server-requirements">VCL Web Server Requirements</h3>

<h4 id="php-ldap">php-ldap</h4>

<p>The VCL web code requires the php-ldap package.  Execute the following command if the package is not already installed:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum install -y php-ldap
</code></pre></div></div>

<h4 id="trusted-ldap-server-certificate">Trusted LDAP Server Certificate</h4>

<p>The VCL web server must trust the LDAP server’s SSL certificate.  If the LDAP server’s SSL certificate was issued by a public, trusted certificate authority (CA) then no additional steps are usually required.</p>

<p>If the LDAP server’s SSL certificate was self-signed, the certificate of the root CA used to sign the LDAP server’s certificate must be installed on the VCL web server.  If the VCL web server is running a Red Hat-based Linux distribution, this normally means that the root CA certificate needs to be added to the following root CA certificate bundle file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/pki/tls/certs/ca-bundle.crt
</code></pre></div></div>

<p>View the certificate authorities included in the ca-bundle.crt file by executing the following command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl crl2pkcs7 -nocrl -certfile /etc/pki/tls/certs/ca-bundle.crt | openssl pkcs7 -print_certs -noout
</code></pre></div></div>

<p>To add a root CA certificate to ca-bundle.crt, download the root CA certificate to the following directory on the VCL web server:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/pki/ca-trust/source/anchors/
</code></pre></div></div>

<p>Then execute the following command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>update-ca-trust extract
</code></pre></div></div>

<p>The certificate authority should now appear in the ca-bundle.crt file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl crl2pkcs7 -nocrl -certfile /etc/pki/tls/certs/ca-bundle.crt | openssl pkcs7 -print_certs -noout
subject=/DC=org/DC=example/DC=ad/DC=vcl/CN=vcl-DC01-CA-1
issuer=/DC=org/DC=example/DC=ad/DC=vcl/CN=vcl-DC01-CA-1
</code></pre></div></div>

<p>After adding the certificate, restart httpd:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service httpd restart
</code></pre></div></div>

<p>You can verify that the certificate is properly installed using this command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl s_client -showcerts -CAfile /etc/pki/tls/certs/ca-bundle.crt -connect your.ldap.server.here:636
</code></pre></div></div>

<p>If you see “Verify return code: 0 (ok)” at the end of the output then it is installed correctly. If you see a different return code, then you’ll need to troubleshoot the problem.</p>

<p>You may need to add a line to /etc/openldap/ldap.conf to point to the ca-bundle.crt file. If so, add the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TLS_CACERT /etc/pki/tls/certs/ca-bundle.crt
</code></pre></div></div>

<p>You already have this if you have an Active Directory system set up.</p>

<p>Next, you (probably) need to add an affiliation to VCL so that users logging in via the new LDAP connection will all be associated together.</p>

<p>Finally, you need to modify the web code conf.php file to have information about how to connect to the LDAP server.</p>

<p>You will also need to make sure your web server can trust the SSL certificate and access it through any firewalls.</p>

<h2 id="add-ldap-authentication-parameters-to-confphp">Add LDAP Authentication Parameters to conf.php</h2>
<p>The conf.php file on the VCL web server contains an authentication configuration parameter section for each affiliation:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/ var/www/html/vcl-trunk/.ht-inc/conf.php
</code></pre></div></div>

<p>Within <strong><em>conf.php</em></strong> is a variable named <strong>$authMechs</strong>.  This variable is a <a href="https://www.w3schools.com/php/php_arrays.asp">PHP associative array</a> containing authentication parameters for each authentication method shown in the drop-down box on the VCL website’s login page.</p>

<h2 id="vcl-login-page-drop-down-box-entry-names">VCL Login Page Drop-Down Box Entry Names</h2>
<p>You will need to add an entry to the <strong>$authMechs</strong> array with information specific to your LDAP directory.  The keys of the <strong><em>$authMechs associative array</em></strong> variable determine the the names and order of the authentication method drop-down box on the VCL website login page.  For example, if the variable contains the following:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$authMechs = array(
  "VCL University" =&gt; array(),
  "Local Account" =&gt; array(),
  "Chicago Cubs" =&gt; array(),
);
</code></pre></div></div>

<p>The following entries would be shown:</p>

<p><img src="images/image2017-2-22 16_44_49.png" width="400" border="1" /></p>

<h2 id="confphp-ldap-authentication-parameters">conf.php LDAP Authentication Parameters</h2>

<p>Each <strong>$authMechs</strong> array entry must contain several parameter-value pairs.  The parameters related to LDAP authentication are:</p>

<p>/////////////////////////////////////////INSERT TABLE HERE\\\\\\\\\\\\\\\\\\\\\\\\\\\\\</p>

<h2 id="add-the-ldap-configuration-parameters-to-confphp">Add the LDAP Configuration Parameters to conf.php</h2>

<p>The code in <strong><em>conf.php</em></strong> where <strong>$authMechs</strong> is defined contains a commented-out “<strong><em>EXAMPLE1 LDAP</em></strong>” section:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*"EXAMPLE1 LDAP" =&gt; array("type" =&gt; "ldap",
                           "server" =&gt; "ldap.example.com",   # hostname of the ldap server
                           "binddn" =&gt; "dc=example,dc=com",  # base dn for ldap server
                           "userid" =&gt; "%s@example.com",     # this is what we add to the actual login id to authenticate a user via ldap
                                                             #    use a '%s' where the actual login id will go
                                                             #    for example1: 'uid=%s,ou=accounts,dc=example,dc=com'
                                                             #        example2: '%s@example.com'
                                                             #        example3: '%s@ad.example.com'
                           "unityid" =&gt; "samAccountName",    # ldap field that contains the user's login id
                           "firstname" =&gt; "givenname",       # ldap field that contains the user's first name
                           "lastname" =&gt; "sn",               # ldap field that contains the user's last name
                           "email" =&gt; "mail",                # ldap field that contains the user's email address
                           "defaultemail" =&gt; "@example.com", # if for some reason an email address may not be returned for a user, this is what
                                                             #    can be added to the user's login id to send mail
                           "masterlogin" =&gt; "vcluser",       # privileged login id for ldap server
                           "masterpwd" =&gt; "*********",       # privileged login password for ldap server
                           "affiliationid" =&gt; 3,             # id from affiliation id this login method is associated with
                           "lookupuserbeforeauth" =&gt; 0,      # set this to 1 to have VCL use masterlogin to lookup the full DN of the user
                                                             #   and use that for the ldap bind to auth the user instead of just using the userid
                                                             #   field from above
                           "lookupuserfield" =&gt; '',          # if lookupuserbeforeauth is set to 1, this is the attribute to use to search in ldap
                                                             #   for the user.  Typically either 'cn', 'uid', or 'samaccountname'
                           "help" =&gt; "Use EXAMPLE1 LDAP if you are using an EXAMPLE1 account"), # message to be displayed on login page about when
                                                                                                #   to use this login mechanism*/
</code></pre></div></div>

<p>You can either uncomment the “<strong><em>EXAMPLE1 LDAP</em></strong>” section and modify it or copy and paste the following into the file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"My LDAP" =&gt; array(
    "type" =&gt; "ldap",
    "server" =&gt; "",
    "binddn" =&gt; "",
    "userid" =&gt; "",
    "unityid" =&gt; "",
    "firstname" =&gt; "",
    "lastname" =&gt; "",
    "email" =&gt; "",
    "defaultemail" =&gt; "",
    "masterlogin" =&gt; "",
    "masterpwd" =&gt; "",
    "affiliationid" =&gt; 0,
    "lookupuserbeforeauth" =&gt; 1,
    "lookupuserfield" =&gt; '',
    "help" =&gt; ""
),
</code></pre></div></div>

<p>A completed entry inserted at the beginning of the <strong>$authMechs</strong> variable would look like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$authMechs = array(
    "VCL University" =&gt; array(
            "type" =&gt; "ldap",
            "server" =&gt; "dc01.vcl.ad.example.org",
            "binddn" =&gt; "OU=VCL Users,DC=vcl,DC=ad,DC=example,DC=org",
            "userid" =&gt; "%s@vcl.ad.example.org",
            "unityid" =&gt; "samAccountName",
            "firstname" =&gt; "givenName",
            "lastname" =&gt; "sn",
            "email" =&gt; "mail",
            "defaultemail" =&gt; "@vcl.ad.example.org",
            "masterlogin" =&gt; "vcl-reader",
            "masterpwd" =&gt; "**********",
            "affiliationid" =&gt; 3,
            "lookupuserbeforeauth" =&gt; 1,
            "lookupuserfield" =&gt; 'samAccountName',
            "help" =&gt; "Select &lt;b&gt;&lt;u&gt;VCL University&lt;/u&gt;&lt;/b&gt; if you are a student of VCL University."
    ),
    /"Shibboleth (UNC Federation)" =&gt; array("type" =&gt; "redirect",
    ...
</code></pre></div></div>

<h2 id="test-the-ldap-connection">Test the LDAP Connection</h2>

<p>It’s helpful to test the LDAP configuration parameters you enter into <strong><em>conf.php</em></strong> using a utility such as  ldapsearch before attempting to log into the VCL website as an LDAP user.  The <strong>ldapsearch</strong> utility is part of the openldap-clients package.  Install openldap-clients by executing the following command on the VCL web server:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum install -y openldap-clients
</code></pre></div></div>

<p>If the Active Directory domain controller is not properly registered in DNS, add it to the /etc/hosts file on the VCL web server</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ldapsearch -h dc01.vcl.ad.example.org -x -b 'OU=VCL Users,DC=vcl,DC=ad,DC=example,DC=org' -D 'vcl-reader@vcl.ad.example.org' -W cn=*
</code></pre></div></div>


      
      <div class="footer border-top border-gray-light mt-5 pt-3 text-right text-gray">
        This site is open source. <a href="http://github.com/pathoma4/vcl/edit/gh-pages/ConfiguringLDAPAuthentication.md">Improve this page</a>.
      </div>
      
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js" integrity="sha256-lZaRhKri35AyJSypXXs4o6OPFTbTmUoltBbDCbdzegg=" crossorigin="anonymous"></script>
    <script>anchors.add();</script>
    
  </body>
</html>
